{% extends "home/base.html" %}
{% load static %}
{% csrf_token %}

{% block addon_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'drug/css/atc_lookup.css' %}">
{% endblock %}

{% block content %}
    {% autoescape off %}
        <div class="atc-intro">
            <h1>ATC/DDD Index 2023</h1>
            <div>
                <p>
                    A searchable version of the complete ATC index with DDDs is available below. The search options
                    enable you to find ATC codes and DDDs for substance name <br>
                    and/or ATC levels. In your search result you may choose to show or hide the text from the Guidelines
                    for ATC classification and DDD assignment linked to <br>
                    the ATC level. The text in the Guidelines will give information related to the background for the
                    ATC and DDD assignment.
                </p>
            </div>

            <h2 style="margin-top: 10px;">Search query</h2>
        </div>

        <div class="row">
            <form method="GET">
                <div id="input-group">
                    <input id="atc_code_query" type="text" style="height:80%;" placeholder="ATC code">
                    <div><span>or</span></div>
                    <div id="name-input">
                        <input id="atc_name_query" type="text" placeholder="name">
                        <!-- Dropdown List -->
                        <select id="queryOption">
                            <option value="containing">containing query</option>
                            <option value="startingwith">starting with query</option>
                        </select>
                    </div>
                    <button type="submit" style="height:80%; font-weight: 600;" id='search'>Search</button>
                </div>
            </form>
        </div>

        <div class="atc-intro">
            <h2>ATC code</h2>
            <ul>
                <li>All ATC levels are searchable.</li>
                <li>A search will result in showing the exact substance or level and all ATC levels above (up to 1st ATC
                    level).
                </li>
            </ul>
        </div>
        <table id="atc-l1">
            <tbody>
            {% for group in group1s %}
                <tr>
                    <td style="margin: 0 10px; display: block; font-weight:400; font-size: 18px;"
                        class="color-{{ forloop.counter }}">{{ group.id }}</td>
                    <td><a href="{% url 'atc-detail-view' %}?group_id={{ group.id }}&group_name={{ group.name }}"
                           target="_blank">{{ group.name }} </a><a href="#" class="info"><i class="fas fa-info"></i>
                    </a></td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="2">No data available</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endautoescape %}
{% endblock %}

{% block addon_js %}
    <script>
        $(document).ready(function () {
            function performSearch() {
                // Get user input
                var atc_code_inp = $("#atc_code_query").val();
                var atc_name_inp = $("#atc_name_query").val();
                var query_option = $("#queryOption").val();

                // Determine whether to use GET or POST based on your needs
                var method = "GET"; // or "POST" depending on the view's requirements

                // Make an AJAX request to the Django view
                $.ajax({
                    url: "{% url 'atc_search_view' %}", // Replace with the actual URL
                    method: method,
                    data: {
                        'atc_code_inp': atc_code_inp,
                        'atc_name_inp': atc_name_inp,
                        'query_option': query_option
                    },
                    success: function (data) {
                        // Handle the returned data (e.g., display it on the page)
                        console.log(data);
                        // You can update the page with the search results here
                        // Open the response data in a new tab
                        var newWindow = window.open('', '_blank');
                        newWindow.document.write(data);
                    },
                    error: function (error) {
                        console.error("Error:", error);
                    }
                });
            }

            // Handle the form submission when the "Search" button is clicked
            $("#search").click(function () {
                performSearch();
            });

            // Handle the form submission when the form is submitted
            $("form").submit(function (event) {
                event.preventDefault(); // Prevent the form from submitting normally
                performSearch(); // Call the search function
            });
        });

    </script>
{% endblock %}